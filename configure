#!/bin/bash

# Functions
function die() {
    echo $PGM: $*
    exit 1
}

function usage () {
    die "[ -h | --help | --with-instans-home=<path-instans-home-dir> ]"
}

PGM=$0

ROOT=`pwd`

while [ $# -gt 0 ] ; do
    case $1 in
	-h|--help) usage ;;
	--with-instans-home=*)
	  INSTANS_HOME=${1#--with-instans-home=}
	  ;;
    esac
    shift
done
if test "$INSTANS_HOME" == ""; then
    INSTANS=`which instans`
    if test -x "$INSTANS"; then
	INSTANS_HOME=`(cd $(dirname $INSTANS)/..; pwd)`
    else
	INSTANS_HOME=../instans
    fi
fi
test -d "$INSTANS_HOME" -a "$INSTANS_HOME"/bin/instans || die "Did not find INSTANS_HOME"
echo "Using INSTANS_HOME=$INSTANS_HOME"
SUITES=$ROOT/suites
STATISTICS=$ROOT/statistics
echo "Creating Makefile"
{
cat <<EOF
ROOT=$ROOT
SUITES=$SUITES
INSTANS_TEST_RESULTS=\$(SUITES)/results.csv
STATISTICS=$STATISTICS
LOG=\$(SUITES)/LOG

INSTANS_HOME=$INSTANS_HOME
INSTANS=\$(INSTANS_HOME)/bin/instans
INSTANS_BIN=\$(INSTANS_HOME)/bin/instans.bin

all: save-old instans-info statistics compare-to-prev

full: makeinstans save-old instans-info statistics

makeinstans:
	(cd \$(INSTANS_HOME); make)

save-old:
	tools/save-results.sh

instans-info:
	tools/instans-info.sh \$(INSTANS_HOME) \$(INSTANS) \$(INSTANS_BIN) \$(STATISTICS)

statistics: \$(INSTANS_TEST_RESULTS)
	tools/test_statistics.py \$(INSTANS_TEST_RESULTS) \$(STATISTICS)

\$(INSTANS_TEST_RESULTS): \$(INSTANS_BIN)
	tools/run-tests.sh \$(INSTANS) \$(ROOT) \$(LOG)

compare-to-prev:
	-tools/compare-results.sh

clean:
	-rm \$(INSTANS_TEST_RESULTS) \$(STATISTICS)/*.csv

.PHONY: statistics force save-old makeinstans full

EOF
} > Makefile
mkdir -p $SUITES
cd $SUITES
if test -d data-r2; then
    echo "data-r2 already exists, skipping downloading it" > /dev/null
else
    echo "Downloading http://www.w3.org/2001/sw/DataAccess/tests/data-r2.tar.gz"
    curl -s -O http://www.w3.org/2001/sw/DataAccess/tests/data-r2.tar.gz
    tar -xzf data-r2.tar.gz test-suite-archive/data-r2
    echo "Moving test-suite-archive/data-r2 to data-r2"
    mv test-suite-archive/data-r2 .
    rm -rf test-suite-archive data-r2.tar.gz
fi
if test -d data-sparql11; then
    echo "data-sparql11 already exists, skipping downloading it" > /dev/null
else
    echo "Downloading http://www.w3.org/2009/sparql/docs/tests/sparql11-test-suite-20121023.tar.gz"
    curl -s -O http://www.w3.org/2009/sparql/docs/tests/sparql11-test-suite-20121023.tar.gz
    tar -xzf sparql11-test-suite-20121023.tar.gz
    echo "Moving sparql11-test-suite to data-sparql11"
    mv sparql11-test-suite data-sparql11
    rm sparql11-test-suite-20121023.tar.gz 
fi
echo "Done."
